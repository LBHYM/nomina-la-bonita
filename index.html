/**
 * La Bonita - Nómina (API) - V2
 *
 * 1) Crea un Google Sheet vacío
 * 2) Extensiones -> Apps Script
 * 3) Pega este código y guarda
 * 4) Implementar -> Nueva implementación -> Aplicación web
 *    - Ejecutar como: tú
 *    - Quién tiene acceso: Cualquiera
 * 5) Copia la URL y pégala en la app (URL del Web App)
 */

const API_KEY = ""; // opcional: pon una clave

function doPost(e){
  try{
    const body = JSON.parse(e.postData.contents || "{}");

    if(API_KEY && body.apiKey !== API_KEY){
      return json({ ok:false, error:"API_KEY inválida" });
    }

    if(body.action === "upload"){
      writeAll(body);
      return json({ ok:true });
    }

    if(body.action === "download"){
      const data = readAll();
      return json({ ok:true, ...data });
    }

    return json({ ok:false, error:"Acción no válida" });
  }catch(err){
    return json({ ok:false, error:String(err) });
  }
}

function json(obj){
  return ContentService.createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}

function ss(){
  return SpreadsheetApp.getActiveSpreadsheet();
}
function sheet(name){
  const s = ss().getSheetByName(name);
  return s || ss().insertSheet(name);
}

function writeAll(body){
  const records = Array.isArray(body.records) ? body.records : [];
  const bonos = body.bonos || {PA:{},EX:{}};
  const playeraPlan = body.playeraPlan || {};

  const shR = sheet("records");
  shR.clearContents();
  shR.appendRow(["id","fecha","empleada","horaProg","entrada","salida","horasManual","videos","playeraAplicar","tarde","notas"]);
  records.forEach(r=>{
    shR.appendRow([
      r.id || "",
      r.fecha || "",
      r.empleada || "",
      r.horaProg || "",
      r.entrada || "",
      r.salida || "",
      Number(r.horasManual || 0),
      Number(r.videos || 0),
      r.playeraAplicar ? "1" : "0",
      r.tarde ? "1" : "0",
      r.notas || ""
    ]);
  });

  const shB = sheet("bonos");
  shB.clearContents();
  shB.appendRow(["tipo","empleada","bonoMonto"]);
  ["Lupita","Paulina","Angelica","Lisa"].forEach(n=>{
    shB.appendRow(["PA", n, Number(((bonos.PA||{})[n]) || 0)]);
  });
  ["Lupita","Paulina","Angelica","Lisa"].forEach(n=>{
    shB.appendRow(["EX", n, Number(((bonos.EX||{})[n]) || 0)]);
  });

  const shP = sheet("playeraPlan");
  shP.clearContents();
  shP.appendRow(["empleada","costoTotal","mitadEmpleado","saldoEmpleado"]);
  ["Lupita","Paulina","Angelica","Lisa"].forEach(n=>{
    const p = playeraPlan[n] || {};
    shP.appendRow([
      n,
      Number(p.costoTotal || 0),
      Number(p.mitadEmpleado || 0),
      Number(p.saldoEmpleado || 0)
    ]);
  });

  const shM = sheet("meta");
  shM.clearContents();
  shM.appendRow(["updatedAt"]);
  shM.appendRow([new Date().toISOString()]);
}

function readAll(){
  const shR = sheet("records");
  const rows = shR.getDataRange().getValues();
  const records = [];
  for(let i=1;i<rows.length;i++){
    const row = rows[i];
    if(!row[0]) continue;
    records.push({
      id: String(row[0]),
      fecha: String(row[1]),
      empleada: String(row[2]),
      horaProg: String(row[3]),
      entrada: String(row[4]),
      salida: String(row[5]),
      horasManual: Number(row[6] || 0),
      videos: Number(row[7] || 0),
      playeraAplicar: String(row[8]) === "1",
      tarde: String(row[9]) === "1",
      notas: String(row[10] || "")
    });
  }

  const shB = sheet("bonos");
  const b = shB.getDataRange().getValues();
  const bonos = { PA:{}, EX:{} };
  for(let i=1;i<b.length;i++){
    const row = b[i];
    if(!row[0] || !row[1]) continue;
    const tipo = String(row[0]);
    const emp = String(row[1]);
    const monto = Number(row[2] || 0);
    if(tipo === "PA") bonos.PA[emp] = monto;
    if(tipo === "EX") bonos.EX[emp] = monto;
  }

  const shP = sheet("playeraPlan");
  const p = shP.getDataRange().getValues();
  const playeraPlan = {};
  for(let i=1;i<p.length;i++){
    const row = p[i];
    if(!row[0]) continue;
    playeraPlan[String(row[0])] = {
      costoTotal: Number(row[1] || 0),
      mitadEmpleado: Number(row[2] || 0),
      saldoEmpleado: Number(row[3] || 0),
    };
  }

  return { records, bonos, playeraPlan };
}

